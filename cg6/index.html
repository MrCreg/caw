<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Room Display</title>
    <link rel="stylesheet" href="room.css">
</head>
<body>

    <!-- Header Section -->
    <header id="header">
        <div class="left-section">C-G-6</div>
        <div class="right-section" id="meetingStatus">Room Available</div>
    </header>

    <!-- Main Meeting Data Section -->
    <main id="meetingData">
        <!-- Dynamic meeting data will be inserted here -->
    </main>

    <!-- Footer Section -->
    <footer>
        Etihad Aviation Training <img src="eatlogo.png" alt="Logo" class="footer-logo">
    </footer>

    <script>
        // Function to fetch meeting data from an ICS file
        async function fetchMeetingData(icsFileURL) {
            try {
                const response = await fetch(icsFileURL);
                const data = await response.text();
                return parseICSData(data);
            } catch (error) {
                // Log an error message and return an empty array in case of an error
                console.error('Error fetching meeting data:', error);
                return [];
            }
        }

        // Function to parse ICS data and extract relevant information
        function parseICSData(icsData) {
            const meetings = [];

            // Regular expression pattern to match each VEVENT block in the ICS data
            const regexEvent = /BEGIN:VEVENT([\s\S]*?)END:VEVENT/g;

            // ... (Other regular expressions for extracting specific fields within a VEVENT block)

            let matchEvent;

            // Current date for dynamic filtering
            const currentDate = new Date();

            // Iterate through each VEVENT block in the ICS data
            while ((matchEvent = regexEvent.exec(icsData)) !== null) {
                const eventBlock = matchEvent[1];

                // ... (Extract individual fields from the VEVENT block)

                // Check if the meeting is scheduled for the current day
                const meetingDate = new Date(start);
                if (
                    meetingDate.getDate() === currentDate.getDate() &&
                    meetingDate.getMonth() === currentDate.getMonth() &&
                    meetingDate.getFullYear() === currentDate.getFullYear()
                ) {
                    // Add the extracted meeting information to the array
                    meetings.push({ uid, start, end, summary, description, location });
                }
            }

            return meetings;
        }

        // Function to generate meeting information
        function generateMeetingInfo(meeting) {
            const now = new Date();
            const startTime = new Date(meeting.start);
            const endTime = new Date(meeting.end);
            const durationMS = endTime.getTime() - startTime.getTime();
            const isInProgress = startTime <= now && now <= endTime;

            const minutesDiff = Math.floor(durationMS / (1000 * 60));
            const hoursDiff = Math.floor(minutesDiff / 60);
            var diffString = "";

            if (hoursDiff >= 1) {
                diffString = `${hoursDiff} ${hoursDiff === 1 ? 'hour' : 'hours'}`;
            } else {
                diffString = `${minutesDiff} ${minutesDiff === 1 ? 'minute' : 'minutes'}`;
            }

            // Add the "current-meeting" class for the in-progress meeting
            return `
                <div class="meeting-info ${isInProgress ? 'in-progress' : ''}">
                    <h1>${formatTime(meeting.start)} to ${formatTime(meeting.end)} (${diffString})</h1>
                    <h3>Booked By: ${meeting.summary}</h3>
                </div>
            `;
        }

        // ... (Other functions)

        // Optionally, you can set up a timer to check and update the header periodically
        setInterval(function () {
            // Fetch meeting data, populate the meeting data, and update the header
            fetchMeetingData('cg6.ics').then(function (data) {
                populateMeetingData(data);
                updateHeader(data);
            });
        }, 60000); // Check every minute

        // ... (Other functions)

        // Helper function to extract values using a regular expression
        function getValueFromRegex(regex, text) {
            const match = regex.exec(text);
            return match ? match[1] : null;
        }

        // ... (Other functions)

        // Function to format time and adjust to GST (UTC+4)
        function formatTime(dateTimeString) {
            const dateTime = new Date(dateTimeString);

            // Adjust the hours to GST (UTC+4)
            dateTime.setUTCHours(dateTime.getUTCHours() + 4);

            const hours = dateTime.getUTCHours();
            const minutes = dateTime.getUTCMinutes();

            // Pad single-digit minutes with a leading zero
            const formattedMinutes = minutes < 10 ? `0${minutes}` : minutes;

            return `${hours}:${formattedMinutes}`;
        }

        // Fetch meeting data and display on page when script runs
        fetchMeetingData('cg6.ics');

    </script>

</body>
</html>
